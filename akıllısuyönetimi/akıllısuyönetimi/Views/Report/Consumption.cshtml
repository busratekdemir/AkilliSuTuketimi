@using System.Security.Claims
@{
    // Rol kontrolü: Admin mi Kullanıcı mı?
    var userRole = User.FindFirst(ClaimTypes.Role)?.Value;
    bool isAdmin = userRole == "Admin";
    ViewData["Title"] = isAdmin ? "Tüketim Raporları" : "Tüketim Analizlerim";
}

<div class="container-fluid py-4 px-4" style="background-color: #f8fbff; min-height: 100vh;">

    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="fw-bold text-dark mb-0">@(isAdmin ? "Tüketim Raporları" : "Tüketim Analizlerim")</h2>
            <p class="text-muted mb-0">@(isAdmin ? "Detaylı su tüketim analizleri ve karşılaştırmaları" : "Kişisel su tüketim verileriniz ve fatura analizleriniz")</p>
        </div>
        @* Rapor İndir Butonu *@
        <button id="btnDownloadReport" class="btn btn-primary rounded-3 px-4 py-2 fw-bold shadow-sm">
            <i class="bi bi-cloud-download me-2"></i> Rapor İndir
        </button>
    </div>

    @* İstatistik Kartları *@
    <div class="row g-4 mb-4">
        <div class="col-md-@(isAdmin ? "3" : "4")">
            <div class="card border-0 shadow-sm rounded-3 overflow-hidden h-100" style="border: 1px solid #dee2e6 !important;">
                <div class="p-2 px-3 bg-light text-muted fw-bold border-bottom" style="font-size: 0.8rem; letter-spacing: 0.5px;">BU AY TOPLAM</div>
                <div class="card-body p-4 text-center">
                    <h3 id="stat-total" class="fw-bold mb-0">@(isAdmin ? "1,350,450" : "18.5") <small class="fs-6">m³</small></h3>
                </div>
                <div class="p-2 px-3 bg-white border-top text-danger fw-bold" style="font-size: 0.85rem;">
                    <i class="bi bi-caret-down-fill"></i> %8.2 azalma
                </div>
            </div>
        </div>

        <div class="col-md-@(isAdmin ? "3" : "4")">
            <div class="card border-0 shadow-sm rounded-3 overflow-hidden h-100" style="border: 1px solid #dee2e6 !important;">
                <div class="p-2 px-3 bg-light text-muted fw-bold border-bottom" style="font-size: 0.8rem; letter-spacing: 0.5px;">GÜNLÜK ORTALAMA</div>
                <div class="card-body p-4 text-center">
                    <h3 class="fw-bold mb-0">@(isAdmin ? "45,015" : "0.62") <small class="fs-6">m³</small></h3>
                </div>
                <div class="p-2 px-3 bg-white border-top text-danger fw-bold" style="font-size: 0.85rem;">
                    <i class="bi bi-caret-up-fill"></i> %3.1 artış
                </div>
            </div>
        </div>

        @if (isAdmin)
        {
            <div class="col-md-3">
                <div class="card border-0 shadow-sm rounded-3 overflow-hidden h-100" style="border: 1px solid #dee2e6 !important;">
                    <div class="p-2 px-3 bg-light text-muted fw-bold border-bottom" style="font-size: 0.8rem; letter-spacing: 0.5px;">KİŞİ BAŞI TÜKETİM</div>
                    <div class="card-body p-4 text-center">
                        <h3 class="fw-bold mb-0">142 <small class="fs-6">lt/gün</small></h3>
                    </div>
                    <div class="p-2 px-3 bg-white border-top text-success fw-bold" style="font-size: 0.85rem;">
                        <i class="bi bi-caret-down-fill"></i> %2.5 azalma
                    </div>
                </div>
            </div>
        }

        <div class="col-md-@(isAdmin ? "3" : "4")">
            <div class="card border-0 shadow-sm rounded-3 overflow-hidden h-100" style="border: 1px solid #dee2e6 !important;">
                <div class="p-2 px-3 bg-light text-muted fw-bold border-bottom" style="font-size: 0.8rem; letter-spacing: 0.5px;">TASARRUF POTANSİYELİ</div>
                <div class="card-body p-4 text-center">
                    <h3 class="fw-bold mb-0 text-primary">@(isAdmin ? "18,500" : "2.4") <small class="fs-6">m³</small></h3>
                </div>
                <div class="p-2 px-3 bg-white border-top text-muted fw-bold" style="font-size: 0.85rem;">Bu ay için öngörülen</div>
            </div>
        </div>
    </div> 

       
    @* FİLTRELEME PANELİ: Admin için tam fonksiyonel *@
    @if (isAdmin)
    {
        <div class="card border-0 shadow-sm p-4 mb-4 rounded-4 bg-white">
            <form id="filterForm" class="row g-3 align-items-end">
                <div class="col-md-3">
                    <label class="form-label small fw-bold text-muted">Dönem:</label>
                    <select id="period" class="form-select border-1 rounded-3">
                        <option selected>Aylık</option>
                        <option>Haftalık</option>
                        <option>Günlük</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label small fw-bold text-muted">Bölge:</label>
                    <select id="regionSelect" class="form-select border-1 rounded-3">
                        <option value="Tümü" selected>Tüm İlçeler</option>
                        <option value="Konak">Konak</option>
                        <option value="Bornova">Bornova</option>
                        <option value="Karşıyaka">Karşıyaka</option>
                        <option value="Çiğli">Çiğli</option>
                        <option value="Bayraklı">Bayraklı</option>
                        <option value="Gaziemir">Gaziemir</option>
                    </select>
                </div>
                <div class="col-md-4">
                    <label class="form-label small fw-bold text-muted">Tarih Aralığı:</label>
                    <div class="input-group">
                        @* ID'ler eklenerek seçim aktif hale getirildi *@
                        <input type="date" id="startDate" class="form-control border-1 rounded-start-3" value="2025-11-01">
                        <input type="date" id="endDate" class="form-control border-1 rounded-end-3" value="2025-12-20">
                    </div>
                </div>
                <div class="col-md-2">
                    <button type="submit" class="btn btn-dark w-100 rounded-3 py-2 fw-bold">Uygula</button>
                </div>
            </form>
        </div>
    }

    @* GRAFİKLER *@
    <div class="row g-4 mb-4">
        <div class="col-md-@(isAdmin ? "8" : "12")">
            <div class="card border-0 shadow-sm rounded-4 p-4 bg-white">
                <h5 class="fw-bold text-dark"><i class="bi bi-graph-up me-2 text-primary"></i> @(isAdmin ? "6 Aylık Tüketim Trendi" : "Tüketim Trendim")</h5>
                <div style="height: 350px;">
                    <canvas id="consumptionTrendChart"></canvas>
                </div>
            </div>
        </div>
        @if (isAdmin)
        {
            <div class="col-md-4">
                <div class="card border-0 shadow-sm rounded-4 p-4 bg-white">
                    <h5 class="fw-bold text-dark"><i class="bi bi-bar-chart-fill me-2 text-primary"></i> İlçe Karşılaştırma</h5>
                    <div style="height: 350px;">
                        <canvas id="districtComparisonChart"></canvas>
                    </div>
                </div>
            </div>
        }
    </div>

    @* TABLOLAR *@
    @if (isAdmin)
    {
        <div class="card border-0 shadow-sm rounded-4 overflow-hidden bg-white mb-5">
            <div class="bg-light p-3 border-bottom">
                <h6 class="mb-0 fw-bold"><i class="bi bi-geo-alt-fill me-2"></i> İlçe Detaylı Tüketim Verileri</h6>
            </div>
            <table id="detailsTable" class="table align-middle mb-0 table-hover">
                <thead class="bg-light text-muted small fw-bold">
                    <tr>
                        <th class="ps-4 py-3">İLÇE</th>
                        <th>BU AY (m³)</th>
                        <th>GEÇEN AY (m³)</th>
                        <th>DEĞİŞİM</th>
                        <th>ABONE SAYISI</th>
                        <th class="text-end pe-4">ORTALAMA</th>
                    </tr>
                </thead>
                <tbody>
                    <tr data-region="Konak">
                        <td class="ps-4 fw-bold text-primary"><i class="bi bi-geo-alt me-2"></i>Konak</td>
                        <td class="val-current">125.000</td>
                        <td>118.821</td>
                        <td><span class="text-danger fw-bold">+5.2%</span></td>
                        <td>12,235</td>
                        <td class="text-end pe-4 fw-bold">8.3 m³</td>
                    </tr>
                    <tr data-region="Bornova">
                        <td class="ps-4 fw-bold text-primary"><i class="bi bi-geo-alt me-2"></i>Bornova</td>
                        <td class="val-current">98.000</td>
                        <td>100.102</td>
                        <td><span class="text-success fw-bold">-2.1%</span></td>
                        <td>12,611</td>
                        <td class="text-end pe-4 fw-bold">6.5 m³</td>
                    </tr>
                    <tr data-region="Karşıyaka">
                        <td class="ps-4 fw-bold text-primary"><i class="bi bi-geo-alt me-2"></i>Karşıyaka</td>
                        <td class="val-current">112.000</td>
                        <td>107.900</td>
                        <td><span class="text-danger fw-bold">+3.8%</span></td>
                        <td>10,923</td>
                        <td class="text-end pe-4 fw-bold">7.5 m³</td>
                    </tr>
                    <tr data-region="Çiğli">
                        <td class="ps-4 fw-bold text-primary"><i class="bi bi-geo-alt me-2"></i>Çiğli</td>
                        <td class="val-current">67.000</td>
                        <td>68.020</td>
                        <td><span class="text-success fw-bold">-1.5%</span></td>
                        <td>14,330</td>
                        <td class="text-end pe-4 fw-bold">4.5 m³</td>
                    </tr>
                    <tr data-region="Bayraklı">
                        <td class="ps-4 fw-bold text-primary"><i class="bi bi-geo-alt me-2"></i>Bayraklı</td>
                        <td class="val-current">89.000</td>
                        <td>85.413</td>
                        <td><span class="text-danger fw-bold">+4.2%</span></td>
                        <td>10,416</td>
                        <td class="text-end pe-4 fw-bold">5.9 m³</td>
                    </tr>
                    <tr data-region="Gaziemir">
                        <td class="ps-4 fw-bold text-primary"><i class="bi bi-geo-alt me-2"></i>Gaziemir</td>
                        <td class="val-current">54.000</td>
                        <td>53.045</td>
                        <td><span class="text-danger fw-bold">+1.8%</span></td>
                        <td>12,633</td>
                        <td class="text-end pe-4 fw-bold">3.6 m³</td>
                    </tr>
                </tbody>
            </table>
        </div>
    }
    else
    {
        <div class="card border-0 shadow-sm rounded-4 overflow-hidden bg-white mb-5">
            <div class="bg-primary p-3">
                <h6 class="mb-0 fw-bold text-white"><i class="bi bi-receipt-cutoff me-2"></i> Son Fatura Geçmişim</h6>
            </div>
            <table class="table align-middle mb-0 table-hover">
                <thead class="bg-light text-muted small fw-bold">
                    <tr>
                        <th class="ps-4 py-3">DÖNEM</th>
                        <th>TÜKETİM (m³)</th>
                        <th>TUTAR (TL)</th>
                        <th>DURUM</th>
                        <th class="text-end pe-4">FATURA</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td class="ps-4 fw-bold">Kasım 2025</td>
                        <td>18.5 m³</td>
                        <td>452.20 TL</td>
                        <td><span class="badge bg-success-subtle text-success border border-success px-3">Ödendi</span></td>
                        <td class="text-end pe-4"><button class="btn btn-sm btn-light border" onclick="showInvoice('Kasım 2025', '18.5', '452.20')"><i class="bi bi-file-earmark-pdf text-danger"></i></button></td>
                    </tr>
                    <tr>
                        <td class="ps-4 fw-bold">Ekim 2025</td>
                        <td>19.3 m³</td>
                        <td>484.25 TL</td>
                        <td><span class="badge bg-success-subtle text-success border border-success px-3">Ödendi</span></td>
                        <td class="text-end pe-4"><button class="btn btn-sm btn-light border" onclick="showInvoice('Ekim 2025', '19.3', '484.25')"><i class="bi bi-file-earmark-pdf text-danger"></i></button></td>
                    </tr>
                </tbody>
            </table>
        </div>
    }
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script>
        function showInvoice(donem, m3, tl) {
            Swal.fire({
                title: `<span style="color:#0d6efd">İZSU Dijital Fatura</span>`,
                html: `
                    <div class="text-start border p-3 rounded bg-light shadow-sm" style="font-family: 'Courier New', Courier, monospace; line-height: 1.6;">
                        <div class="text-center mb-3"><strong>SU TÜKETİM BELGESİ</strong><br><small>${donem}</small></div>
                        <hr>
                        <p class="mb-1"><strong>Abone No:</strong> 19234567</p>
                        <p class="mb-1"><strong>Tüketim Miktarı:</strong> ${m3} m³</p>
                        <p class="mb-1"><strong>Birim Fiyat:</strong> 24.44 TL</p>
                        <hr>
                        <p class="fs-5 text-end mb-0"><strong>TOPLAM TUTAR:</strong> <span class="text-danger">${tl} TL</span></p>
                        <div class="mt-3 small text-center text-muted">Bu bir dijital örnektir. <br> Ödeme Tarihi: 15.11.2025</div>
                    </div>
                `,
                showCloseButton: true,
                confirmButtonText: '<i class="bi bi-printer"></i> Yazdır',
                confirmButtonColor: '#3085d6',
                footer: '<span class="text-success fw-bold"><i class="bi bi-check-circle"></i> Fatura Ödenmiştir</span>'
            });
        }
    </script>

    <script>
        (function() {
            const isAdmin = @(isAdmin.ToString().ToLower());

            document.getElementById('btnDownloadReport').addEventListener('click', function (e) {
                e.preventDefault();

                Swal.fire({
                    title: 'Rapor Hazırlanıyor',
                    text: 'Lütfen bekleyin, veriler derleniyor...',
                    timer: 1500,
                    showConfirmButton: false,
                    didOpen: () => { Swal.showLoading(); }
                }).then(() => {
                    const content = isAdmin
                           ? `İZSU GENEL TÜKETİM RAPORU\n` +
          `Tarih: ${new Date().toLocaleString('tr-TR')}\n` +
          `Toplam Aylık Tüketim: @(ViewBag.TotalUsage ?? "1.350.450") m³\n` +
          `Günlük Ortalama: @(ViewBag.DailyAvg ?? "45.015") m³`
        : `KİŞİSEL TÜKETİM ANALİZİM\n` +
          `Tarih: ${new Date().toLocaleString('tr-TR')}\n` +
          `Bu Ayki Tüketimim: 18.5 m³\n` +
          `Tahmini Fatura: 452.20 TL`;

                    const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = isAdmin ? "Genel_Sistem_Raporu.txt" : "Kisisel_Tuketim_Raporum.txt";
                    a.click();
                });
            });

            const trendCtx = document.getElementById('consumptionTrendChart');
            if (trendCtx) {
                new Chart(trendCtx, {
                    type: 'line',
                    data: {
                        labels: ['Haz', 'Tem', 'Ağu', 'Eyl', 'Eki', 'Kas'],
                        datasets: [{
                            label: isAdmin ? 'Genel Tüketim (m³)' : 'Tüketimim (m³)',
                            data: isAdmin ? [500000, 600000, 620000, 580000, 500000, 450000] : [22.5, 21.0, 19.8, 20.5, 18.5, 19.2],
                            borderColor: '#0d6efd',
                            backgroundColor: 'rgba(13, 110, 253, 0.05)',
                            fill: true,
                            tension: 0.4
                        }]
                    },
                    options: { responsive: true, maintainAspectRatio: false }
                });
            }
                    // Filtreleme Paneli İşlemleri
        const filterForm = document.getElementById('filterForm');
        if (filterForm) {
            filterForm.addEventListener('submit', function (e) {
                e.preventDefault(); // Sayfanın yenilenmesini ENGELLER (Seçilen tarihler kaybolmaz)

                const start = document.getElementById('startDate').value;
                const end = document.getElementById('endDate').value;
                const region = document.getElementById('regionSelect').value;

                Swal.fire({
                    title: 'Veriler Güncelleniyor',
                    html: `<b>${region}</b> bölgesi için <br><b>${start}</b> - <b>${end}</b> tarihleri filtreleniyor...`,
                    icon: 'info',
                    timer: 1500,
                    showConfirmButton: false,
                    didOpen: () => { Swal.showLoading(); }
                }).then(() => {
                    // location.reload(); SİLDİK -> Sayfa yenilenmezse tarihler kutuda kalır

                    // Simülasyon: Grafikteki verileri rastgele değiştiriyoruz
                    const chart = Chart.getChart("consumptionTrendChart"); // Mevcut grafiği bul
                    if (chart) {
                        // Rastgele 6 yeni veri oluştur (0-600000 arası)
                        chart.data.datasets[0].data = Array.from({length: 6}, () => Math.floor(Math.random() * 600000));
                        chart.update(); // Grafiği animasyonla güncelle
                    }
                });
            });
        }

            if (isAdmin) {
                const districtCtx = document.getElementById('districtComparisonChart');
                if (districtCtx) {
                    new Chart(districtCtx, {
                        type: 'bar',
                        data: {
                            labels: ['Konak', 'Bornova', 'K.yaka', 'Çiğli', 'Gaziemir'],
                            datasets: [{
                                data: [125000, 98000, 112000, 67000, 54000],
                                backgroundColor: '#0d6efd',
                                borderRadius: 5
                            }]
                        },
                        options: { responsive: true, maintainAspectRatio: false }
                    });
                }
            }
        })();
    </script>
}